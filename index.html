<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AIì•±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-checkbox:checked {
            background-color: #0d9488;
            border-color: #0d9488;
        }
        .custom-checkbox:checked + span {
            font-weight: 700;
            color: #0f766e;
        }
        
        .pdf-visible { display: none; }
        .print\:hidden { display: grid; }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        #historySidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50; /* ìµœìƒë‹¨ ë…¸ì¶œ */
        }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(100%); }
    </style>
</head>
<body class="bg-teal-50 min-h-screen overflow-x-hidden">
    
    <button onclick="toggleSidebar()" class="fixed top-20 right-0 z-40 bg-teal-700 text-white p-3 rounded-l-xl shadow-lg hover:bg-teal-800 transition">
        <i class="fas fa-history text-xl"></i>
    </button>

    <div id="historySidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl sidebar-closed flex flex-col border-l border-gray-200">
        <div class="p-4 bg-teal-600 text-white flex justify-between items-center">
            <h2 class="font-bold text-lg"><i class="fas fa-list-alt mr-2"></i>ì´ì „ ì§„ë‹¨ ê¸°ë¡</h2>
            <button onclick="toggleSidebar()" class="text-white hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
            <p class="text-center text-gray-400 text-sm mt-10">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="p-4 border-t border-gray-200 bg-white">
            <button onclick="clearHistory()" class="w-full py-2 border border-red-300 text-red-500 rounded-lg hover:bg-red-50 text-sm">
                <i class="fas fa-trash-alt mr-1"></i> ê¸°ë¡ ì „ì²´ ì‚­ì œ
            </button>
        </div>
    </div>

    <div id="capture-area" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl overflow-hidden relative">
        
        <header class="bg-teal-600 p-4 text-white text-center shadow-lg relative">
            <h1 class="text-xl sm:text-2xl font-bold flex items-center justify-center gap-2 whitespace-nowrap">
                <img src="image_1.png" alt="ì²­ê°œêµ¬ë¦¬ ë¡œê³ " class="h-14 w-auto object-contain mix-blend-multiply">
                ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AIì•±
            </h1>
            <div class="flex justify-end mt-1">
                <p class="text-xs text-white font-medium">
                    AI ì´ìŠ¬ì (Dew Point) ì •ë°€ ë¶„ì„ 
                    <span class="text-red-400 font-bold ml-1">Ver 1.5 (History)</span>
                </p>
            </div>
        </header>

        <main class="p-5 pb-20">
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg shadow-sm" id="apiKeySection">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-yellow-800"><i class="fas fa-key mr-2"></i>API í‚¤ ì…ë ¥ (ìµœì´ˆ 1íšŒ)</span>
                </div>
                <div class="flex gap-2">
                    <input type="password" id="apiKey" placeholder="sk-..." class="flex-1 p-2 border border-yellow-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    <button onclick="saveApiKey()" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm font-bold hover:bg-yellow-600 transition">ì €ì¥</button>
                </div>
            </div>

            <div class="space-y-4 mb-6">
                <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-teal-800"><i class="fas fa-thermometer-half mr-2"></i>í˜„ì¬ í™˜ê²½ì •ë³´</h3>
                        <span id="weatherStatus" class="text-xs text-teal-600 animate-pulse">ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...</span>
                    </div>
                    
                    <div class="flex gap-4 mb-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì‹¤ë‚´ì˜¨ë„ (â„ƒ)</label>
                            <input type="number" id="temp" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 bg-white" placeholder="ì§ì ‘ì…ë ¥">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì‹¤ë‚´ìŠµë„ (%)</label>
                            <input type="number" id="humidity" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-teal-500 bg-white" placeholder="ì§ì ‘ì…ë ¥">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì‹¤ì™¸ì˜¨ë„ (ìë™)</label>
                            <input type="number" id="outdoorTemp" class="w-full p-2 border rounded-lg bg-gray-100 text-gray-600" readonly placeholder="ìë™ê°ì§€">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ì‹¤ì™¸ìŠµë„ (ìë™)</label>
                            <input type="number" id="outdoorHumidity" class="w-full p-2 border rounded-lg bg-gray-100 text-gray-600" readonly placeholder="ìë™ê°ì§€">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"><i class="fas fa-home mr-2 text-teal-600"></i>ì§„ë‹¨ ì¥ì†Œ</label>
                    <input type="text" id="location" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition" placeholder="ì˜ˆ: ì•ˆë°© ë² ë€ë‹¤ ë²½ë©´">
                </div>
                
                <label class="block text-sm font-bold text-gray-700 mb-1"><i class="fas fa-map-marker-alt mr-2 text-teal-600"></i>ë°œìƒ ë¶€ìœ„ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ)</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition">
                        <input type="checkbox" value="ë² ë€ë‹¤/ë°œì½”ë‹ˆ" class="custom-checkbox w-5 h-5 text-teal-600 border-2 border-gray-300 rounded focus:ring-teal-500" onchange="updateDefectType()">
                        <span class="ml-3 text-sm text-gray-700">ë² ë€ë‹¤/ë°œì½”ë‹ˆ</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition">
                        <input type="checkbox" value="ì°½ë¬¸/ì°½í˜¸ì£¼ë³€" class="custom-checkbox w-5 h-5 text-teal-600 border-2 border-gray-300 rounded focus:ring-teal-500" onchange="updateDefectType()">
                        <span class="ml-3 text-sm text-gray-700">ì°½ë¬¸ ì£¼ë³€</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition">
                        <input type="checkbox" value="ë²½ ëª¨ì„œë¦¬/ì½”ë„ˆ" class="custom-checkbox w-5 h-5 text-teal-600 border-2 border-gray-300 rounded focus:ring-teal-500" onchange="updateDefectType()">
                        <span class="ml-3 text-sm text-gray-700">ë²½ ëª¨ì„œë¦¬</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition">
                        <input type="checkbox" value="í˜„ê´€/ëŒ€í”¼ì†Œ" class="custom-checkbox w-5 h-5 text-teal-600 border-2 border-gray-300 rounded focus:ring-teal-500" onchange="updateDefectType()">
                        <span class="ml-3 text-sm text-gray-700">í˜„ê´€/ëŒ€í”¼ì†Œ</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition">
                        <input type="checkbox" value="ê°€êµ¬/ë¶™ë°•ì´ì¥ ë’¤" class="custom-checkbox w-5 h-5 text-teal-600 border-2 border-gray-300 rounded focus:ring-teal-500" onchange="updateDefectType()">
                        <span class="ml-3 text-sm text-gray-700">ê°€êµ¬ ë’¤</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-teal-50 transition">
                        <input type="checkbox" value="ì²œì¥/ê¸°íƒ€" class="custom-checkbox w-5 h-5 text-teal-600 border-2 border-gray-300 rounded focus:ring-teal-500" onchange="updateDefectType()">
                        <span class="ml-3 text-sm text-gray-700">ì²œì¥/ê¸°íƒ€</span>
                    </label>
                </div>
                <input type="hidden" id="defectType">

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1"><i class="fas fa-edit mr-2 text-teal-600"></i>ì¦ìƒ ìƒì„¸ ì„¤ëª…</label>
                    <textarea id="description" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 transition" placeholder="ë¬¼ë°©ìš¸ì´ ë§ºíˆëŠ”ì§€, ê³°íŒ¡ì´ê°€ í”¼ì—ˆëŠ”ì§€ ì ì–´ì£¼ì„¸ìš”"></textarea>
                </div>
            </div>

            <div class="bg-gray-100 p-6 rounded-2xl shadow-md mb-6 border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-teal-500"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center text-teal-700">
                    ğŸ“¸ 1. ê²°ë¡œ/ê³°íŒ¡ì´ í˜„ì¥ (í•„ìˆ˜)
                </h3>
                <div class="w-full h-80 bg-white rounded-lg border-2 border-dashed border-gray-300 mb-4 cursor-pointer hover:opacity-90 transition flex items-center justify-center overflow-hidden" onclick="triggerUpload(1)">
                    <img id="preview1" src="placeholder.png" alt="ì‚¬ì§„ ì…ë ¥" class="w-1/4 h-1/4 object-contain opacity-40">
                </div>
                <input type="file" id="fileInput1" accept="image/*" class="hidden" onchange="previewImage(event, 1)">
                <button onclick="triggerUpload(1)" class="w-full bg-teal-100 text-teal-700 py-3 rounded-xl font-bold hover:bg-teal-200 transition flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i> ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ
                </button>
            </div>

            <div class="bg-gray-100 p-6 rounded-2xl shadow-md mb-6 border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center text-cyan-700">
                    ğŸ“¸ 2. í™•ëŒ€/ìƒì„¸ ì‚¬ì§„ (ì„ íƒ)
                </h3>
                <div class="w-full h-80 bg-white rounded-lg border-2 border-dashed border-gray-300 mb-4 cursor-pointer hover:opacity-90 transition flex items-center justify-center overflow-hidden" onclick="triggerUpload(2)">
                    <img id="preview2" src="placeholder.png" alt="ì‚¬ì§„ ì…ë ¥" class="w-1/4 h-1/4 object-contain opacity-40">
                </div>
                <input type="file" id="fileInput2" accept="image/*" class="hidden" onchange="previewImage(event, 2)">
                <button onclick="triggerUpload(2)" class="w-full bg-cyan-100 text-cyan-700 py-3 rounded-xl font-bold hover:bg-cyan-200 transition flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i> ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ
                </button>
            </div>

            <div class="bg-gray-100 p-6 rounded-2xl shadow-md mb-6 border border-gray-200 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-sky-500"></div>
                <h3 class="text-lg font-bold mb-4 flex items-center text-sky-700">
                    ğŸ“¸ 3. ì£¼ë³€ í™˜ê²½/ê¸°íƒ€ ì‚¬ì§„ (ì„ íƒ)
                </h3>
                <div class="w-full h-80 bg-white rounded-lg border-2 border-dashed border-gray-300 mb-4 cursor-pointer hover:opacity-90 transition flex items-center justify-center overflow-hidden" onclick="triggerUpload(3)">
                    <img id="preview3" src="placeholder.png" alt="ì‚¬ì§„ ì…ë ¥" class="w-1/4 h-1/4 object-contain opacity-40">
                </div>
                <input type="file" id="fileInput3" accept="image/*" class="hidden" onchange="previewImage(event, 3)">
                <button onclick="triggerUpload(3)" class="w-full bg-sky-100 text-sky-700 py-3 rounded-xl font-bold hover:bg-sky-200 transition flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i> ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ
                </button>
            </div>

            <button onclick="analyzeImages()" id="analyzeBtn" class="w-full bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:from-teal-600 hover:to-cyan-700 transition transform hover:scale-[1.02] active:scale-95 mb-6">
                <i class="fas fa-search-plus mr-2"></i> AI ê²°ë¡œ ì›ì¸ ë¶„ì„ ì‹œì‘
            </button>

            <div id="loading" class="hidden flex-col items-center justify-center py-10 space-y-4">
                <div class="loader"></div>
                <p class="text-gray-600 animate-pulse font-medium">ğŸ’§ ìŠµë„ì™€ ì˜¨ë„ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>

            <div id="result" class="bg-gray-100 p-6 rounded-2xl shadow-lg border-t-4 border-teal-500 mb-6">
                <h3 class="text-lg font-bold mb-4 flex items-center text-gray-800 border-b border-gray-300 pb-2">
                    <i class="fas fa-clipboard-check text-teal-500 mr-2"></i> ê²°ë¡œë°œìƒì˜ ì›ì¸ê³¼ í•´ê²°ë°©ì•ˆ
                </h3>
                <div id="resultContent" class="prose max-w-none text-gray-700 leading-relaxed text-sm bg-white p-4 rounded-lg border border-gray-200">
                    ì§„ë‹¨ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ AI ì „ë¬¸ê°€ì˜ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="print:hidden">
                <div class="grid grid-cols-[2fr_1fr] gap-4 mt-6">
                    <a href="tel:1599-7380" class="flex items-center justify-center bg-teal-600 text-white px-2 py-3 rounded-xl hover:bg-teal-700 transition shadow-lg font-bold whitespace-nowrap overflow-hidden">
                        <i class="fas fa-phone-alt mr-2"></i> ë¬¸ì˜í•˜ê¸°(1599-7380)
                    </a>
                    <button onclick="savePDF()" class="flex items-center justify-center bg-gray-600 text-white px-2 py-3 rounded-xl hover:bg-gray-700 transition shadow-lg font-bold whitespace-nowrap">
                        <i class="fas fa-file-pdf mr-2"></i> PDF ì €ì¥
                    </button>
                </div>
                <div class="pdf-visible text-center text-gray-500 text-sm mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    ë” ìì„¸í•œ ì •ë°€ì§„ë‹¨ê³¼ ìˆ˜ë¦¬ë¥¼ ì›í•˜ì‹œë©´ ì²­ê°œêµ¬ë¦¬(1599-7380)ë¡œ ë¬¸ì˜í•˜ì‹œê¸¸ ì›í•˜ì‹œë©´ ë¬¸ì˜í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì‹œë©´ ìë™ìœ¼ë¡œ í†µí™”ê°€ ì—°ê²°ë©ë‹ˆë‹¤.
                </div>
            </div>
            
        </main>

        <footer class="bg-gray-800 text-gray-400 py-2 px-2 text-center text-[10px] mt-6 leading-tight">
            <h3 class="text-white text-sm font-bold mb-1">ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ</h3>
            <div class="flex flex-col gap-0.5">
                <p>ìƒí˜¸ : ì²­ê°œêµ¬ë¦¬ìƒ¤ì‹œ | ëŒ€í‘œ : ì „ì˜ì›… | ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ : 123-36-31426</p>
                <p>ê³ ê°ì„¼í„° 1599-7380 (08:00~17:00 ì¼ìš”ì¼ì œì™¸) | COPYRIGHT â“’ 2025 All Rights Reserved.</p>
            </div>
        </footer>

    </div>

    <script>
        // ì´ˆê¸°í™” ë° ë‚ ì”¨ ìë™ ì‹¤í–‰
        window.onload = function() {
            // API í‚¤ í™•ì¸
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                document.getElementById('apiKeySection').style.display = 'none';
            }
            // ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
            fetchOutdoorWeather();
            // ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            renderHistory();
        };

        // ì‹¤ì™¸ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
        function fetchOutdoorWeather() {
            if (!navigator.geolocation) {
                document.getElementById('weatherStatus').innerText = "âŒ ìœ„ì¹˜ì •ë³´ ë¯¸ì§€ì›";
                return;
            }
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                document.getElementById('weatherStatus').innerText = "ğŸ”„ ë‚ ì”¨ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
                
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.current) {
                        document.getElementById('outdoorTemp').value = data.current.temperature_2m;
                        document.getElementById('outdoorHumidity').value = data.current.relative_humidity_2m;
                        document.getElementById('weatherStatus').innerText = "âœ… ì‹¤ì™¸ ë‚ ì”¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ";
                        document.getElementById('weatherStatus').classList.remove('animate-pulse');
                    }
                } catch (e) {
                    console.error(e);
                    document.getElementById('weatherStatus').innerText = "âš ï¸ ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
                }
            }, (err) => {
                console.error(err);
                document.getElementById('weatherStatus').innerText = "âš ï¸ ìœ„ì¹˜ ê¶Œí•œ í•„ìš”";
            });
        }

        // API í‚¤ ì €ì¥ í•¨ìˆ˜
        function saveApiKey() {
            const keyInput = document.getElementById('apiKey');
            const key = keyInput.value.trim();

            if (key) {
                localStorage.setItem('openai_api_key', key);
                alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('apiKeySection').style.display = 'none';
            } else {
                alert('ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function updateDefectType() {
            const checkedTypes = Array.from(document.querySelectorAll('.custom-checkbox:checked'))
                .map(input => input.value);
            document.getElementById('defectType').value = checkedTypes.join(', ');
        }

        function triggerUpload(num) {
            document.getElementById(`fileInput${num}`).click();
        }

        function previewImage(event, num) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(`preview${num}`);
                    img.src = e.target.result;
                    img.classList.remove('w-1/4', 'h-1/4', 'object-contain', 'opacity-40');
                    img.classList.add('w-full', 'h-full', 'object-cover');
                    
                    const container = img.parentElement;
                    container.classList.remove('border-dashed', 'border-gray-300');
                    const colors = ['border-teal-500', 'border-cyan-500', 'border-sky-500'];
                    container.classList.add('border-solid', 'border-4', colors[num-1]);
                }
                reader.readAsDataURL(file);
            }
        }

        // ==========================================
        // [ì‹ ê·œ] ì‚¬ì´ë“œë°” ë° íˆìŠ¤í† ë¦¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('historySidebar');
            if (sidebar.classList.contains('sidebar-closed')) {
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                renderHistory(); // ì—´ ë•Œë§ˆë‹¤ ìµœì‹ í™”
            } else {
                sidebar.classList.remove('sidebar-open');
                sidebar.classList.add('sidebar-closed');
            }
        }

        function saveHistory(location, resultText) {
            let history = JSON.parse(localStorage.getItem('diagnosis_history') || '[]');
            const newEntry = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                location: location || "ì¥ì†Œ ë¯¸ì •",
                result: resultText
            };
            history.unshift(newEntry); // ìµœì‹ ìˆœ ì €ì¥
            localStorage.setItem('diagnosis_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('diagnosis_history') || '[]');
            const listEl = document.getElementById('historyList');
            
            if (history.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 text-sm mt-10">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listEl.innerHTML = history.map(item => `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-teal-50 transition" onclick="loadHistoryItem(${item.id})">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-teal-700 text-sm truncate w-2/3">${item.location}</span>
                        <span class="text-xs text-gray-400">${item.date.slice(0, 10)}</span>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-2">${item.result.substring(0, 50)}...</p>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const history = JSON.parse(localStorage.getItem('diagnosis_history') || '[]');
            const item = history.find(h => h.id === id);
            if (item) {
                document.getElementById('location').value = item.location;
                document.getElementById('resultContent').innerHTML = item.result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                toggleSidebar(); // ì‚¬ì´ë“œë°” ë‹«ê¸°
            }
        }

        function clearHistory() {
            if(confirm('ëª¨ë“  ì§„ë‹¨ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('diagnosis_history');
                renderHistory();
            }
        }
        // ==========================================

        async function analyzeImages() {
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                alert('API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const img1 = document.getElementById('fileInput1').files[0];
            if (!img1) {
                alert('ìµœì†Œí•œ í˜„ì¥ ì‚¬ì§„(1ë²ˆ)ì€ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loading').classList.remove('hidden');

            try {
                const images = [];
                if (img1) images.push(await toBase64(img1));
                const img2 = document.getElementById('fileInput2').files[0];
                if (img2) images.push(await toBase64(img2));
                const img3 = document.getElementById('fileInput3').files[0];
                if (img3) images.push(await toBase64(img3));

                const location = document.getElementById('location').value;
                const type = document.getElementById('defectType').value || "ë¯¸ì„ íƒ";
                const desc = document.getElementById('description').value;
                const temp = document.getElementById('temp').value; 
                const humid = document.getElementById('humidity').value;
                const outTemp = document.getElementById('outdoorTemp').value;
                const outHumid = document.getElementById('outdoorHumidity').value;

                let promptText = `ì¥ì†Œ: ${location}, ë¶€ìœ„: ${type}, ì¦ìƒ: ${desc}`;
                let envInfo = "";
                if (temp) envInfo += `ì‹¤ë‚´ì˜¨ë„: ${temp}ë„, `;
                if (humid) envInfo += `ì‹¤ë‚´ìŠµë„: ${humid}%, `;
                if (outTemp) envInfo += `ì‹¤ì™¸ì˜¨ë„: ${outTemp}ë„, `;
                if (outHumid) envInfo += `ì‹¤ì™¸ìŠµë„: ${outHumid}%`;
                
                if (envInfo) {
                    promptText += `\n[í™˜ê²½ì •ë³´] ${envInfo} (ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ìŠ¬ì  ë°œìƒ ê°€ëŠ¥ì„±ì„ ê³„ì‚°í•˜ê³  ë¶„ì„ì— í¬í•¨í•´ì¤˜)`;
                } else {
                    promptText += `\n(ì˜¨ìŠµë„ ì •ë³´ ì—†ìŒ. ì‚¬ì§„ì˜ ë¬¼ë°©ìš¸, ê³°íŒ¡ì´ íŒ¨í„´ì„ ë³´ê³  ì›ì¸ì„ ì¶”ë¡ í•´ì¤˜)`;
                }

                const messages = [
                    {
                        role: "system",
                        content: "ë‹¹ì‹ ì€ ê±´ì¶• ë¬¼ë¦¬í•™ê³¼ ë‹¨ì—´ ì‹œê³µì— ì •í†µí•œ 'ê²°ë¡œ/ê³°íŒ¡ì´ í•´ê²° ì „ë¬¸ê°€'ì…ë‹ˆë‹¤. ì‚¬ì§„ê³¼ ì œê³µëœ í™˜ê²½ ì •ë³´(ì˜¨ë„, ìŠµë„)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²°ë¡œì˜ ì›ì¸(ë‹¨ì—´ ë¶€ì¡±, í™˜ê¸° ë¶€ì¡±, ëˆ„ìˆ˜ ë“±)ì„ ëª…í™•íˆ íŒŒì•…í•˜ê³ , ì‹¤í˜„ ê°€ëŠ¥í•œ í•´ê²°ì±…(í™˜ê¸°ë²•, ë‹¨ì—´ ì‹œê³µ, ì œìŠµ ë“±)ì„ ë‹¨ê³„ë³„ë¡œ ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”."
                    },
                    {
                        role: "user",
                        content: [
                            { type: "text", text: promptText },
                            ...images.map(img => ({ type: "image_url", image_url: { url: img } }))
                        ]
                    }
                ];

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: messages,
                        max_tokens: 2000
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const answer = data.choices[0].message.content;
                
                // [ì‹ ê·œ] ê¸°ë¡ ì €ì¥ í˜¸ì¶œ
                saveHistory(location, answer);

                document.getElementById('resultContent').innerHTML = answer.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                alert('ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function savePDF() {
            const buttons = document.querySelector('.print\\:hidden');
            const pdfVisible = document.querySelector('.pdf-visible');
            const historyBtn = document.querySelector('button[onclick="toggleSidebar()"]'); // ì‚¬ì´ë“œë°” ë²„íŠ¼ ìˆ¨ê¹€

            if(buttons) buttons.style.display = 'none';
            if(historyBtn) historyBtn.style.display = 'none';
            if(pdfVisible) pdfVisible.style.display = 'block';

            window.scrollTo(0, 0);
            
            try {
                const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const fileName = `ê²°ë¡œì§„ë‹¨_${document.getElementById('location').value}_${new Date().toISOString().slice(0,10)}.pdf`;
                pdf.save(fileName);

            } catch (e) {
                alert('PDF ì €ì¥ ì˜¤ë¥˜: ' + e.message);
            } finally {
                if(buttons) buttons.style.display = 'grid';
                if(historyBtn) historyBtn.style.display = 'block';
                if(pdfVisible) pdfVisible.style.display = 'none';
            }
        }
    </script>
</body>
</html>
