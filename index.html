<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AIì•± (MR277 ì •ë°€ë²„ì „)</title>
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        :root {
            --primary-color: #2E7D32; /* ì²­ê°œêµ¬ë¦¬ ì§™ì€ ë…¹ìƒ‰ */
            --secondary-color: #66BB6A;
            --background-color: #F1F8E9;
            --text-color: #333333;
            --white: #FFFFFF;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: var(--white);
            width: 100%;
            max-width: 600px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            box-sizing: border-box;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--background-color);
            padding-bottom: 5px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* ë‚ ì”¨ ì •ë³´ ë°•ìŠ¤ */
        .weather-info {
            background-color: #E8F5E9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #C8E6C9;
        }
        .weather-info p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #2E7D32;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
        .file-upload-wrapper {
            position: relative;
            width: 100%;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fafafa;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary-color);
            background-color: #f1f8e9;
        }

        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .file-upload-icon {
            text-align: center;
            color: #888;
        }

        .file-upload-icon i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .preview-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 5;
            display: none;
            background-color: #000;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        .btn-submit:hover {
            background-color: #1B5E20;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #resultArea {
            margin-top: 30px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: none;
            line-height: 1.6;
        }
        #resultArea h3 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-top: 25px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            background-color: #fff;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .checkbox-item input { margin-right: 8px; }
        
        /* ì¤Œ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
        .image-zoom-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .zoomed-image {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
            border: 2px solid white;
        }
        .close-zoom-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        .zoom-hint {
            font-size: 0.8rem;
            color: #888;
            text-align: center;
            margin-top: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="container">
        <h1>ğŸ¸ ì²­ê°œêµ¬ë¦¬ ê²°ë¡œì§„ë‹¨ AIì•±</h1>
        <p class="subtitle">AI ì´ìŠ¬ì (Dew Point) ì •ë°€ ë¶„ì„ Ver2.1 (MR277 ì—°ë™)</p>

        <div class="section-title">ì§„ë‹¨ ì •ë³´ ì…ë ¥</div>
        <div class="input-group">
            <label for="diagnosisDate">ì§„ë‹¨ ì¼ì</label>
            <input type="datetime-local" id="diagnosisDate">
        </div>

        <div class="input-group">
            <label for="location">ì§„ë‹¨ ì¥ì†Œ</label>
            <input type="text" id="location" placeholder="ì˜ˆ: ì•ˆë°© ë² ë€ë‹¤ ë²½ë©´">
        </div>
        
        <div class="input-group">
            <label>ë°œìƒ ë¶€ìœ„ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ)</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" name="area" value="ë² ë€ë‹¤/ë°œì½”ë‹ˆ"> ë² ë€ë‹¤/ë°œì½”ë‹ˆ</label>
                <label class="checkbox-item"><input type="checkbox" name="area" value="ì°½ë¬¸ ì£¼ë³€"> ì°½ë¬¸ ì£¼ë³€</label>
                <label class="checkbox-item"><input type="checkbox" name="area" value="ë²½ ëª¨ì„œë¦¬"> ë²½ ëª¨ì„œë¦¬</label>
                <label class="checkbox-item"><input type="checkbox" name="area" value="ê°€êµ¬ ë’¤"> ê°€êµ¬ ë’¤</label>
                <label class="checkbox-item"><input type="checkbox" name="area" value="í˜„ê´€/ëŒ€í”¼ì†Œ"> í˜„ê´€/ëŒ€í”¼ì†Œ</label>
                <label class="checkbox-item"><input type="checkbox" name="area" value="ì²œì¥/ê¸°íƒ€"> ì²œì¥/ê¸°íƒ€</label>
            </div>
        </div>

        <div class="section-title">í˜„ì¬ í™˜ê²½ ì •ë³´</div>
        <div class="weather-info" id="weatherDisplay">
            <p><i class="fas fa-map-marker-alt"></i> ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="input-group" style="flex: 1;">
                <label for="tempIn">ì‹¤ë‚´ ì˜¨ë„ (Â°C)</label>
                <input type="number" id="tempIn" placeholder="ì˜ˆ: 22" step="0.1">
            </div>
            <div class="input-group" style="flex: 1;">
                <label for="humidIn">ì‹¤ë‚´ ìŠµë„ (%)</label>
                <input type="number" id="humidIn" placeholder="ì˜ˆ: 50" step="1">
            </div>
        </div>

        <div class="section-title">í˜„ì¥ ì‚¬ì§„ ì—…ë¡œë“œ</div>
        
        <div class="input-group">
            <label>1. ê²°ë¡œ/ê³°íŒ¡ì´ ì‚¬ì§„ (í•„ìˆ˜)</label>
            <div class="file-upload-wrapper" onclick="document.getElementById('fileInput1').click()">
                <input type="file" id="fileInput1" accept="image/*" onchange="previewImage(event, 'preview1')">
                <div class="file-upload-icon">
                    <i class="fas fa-camera"></i>
                    <span>ì‚¬ì§„ ì´¬ì˜ ë˜ëŠ” ì—…ë¡œë“œ</span>
                </div>
                <img id="preview1" class="preview-image" onclick="zoomImage(event)">
            </div>
            <p class="zoom-hint">* ì‚¬ì§„ì„ í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="input-group">
            <label>2. FLIR MR 277ê²€ì‚¬ (ì„ íƒ)</label>
            <div class="file-upload-wrapper" onclick="document.getElementById('fileInput2').click()">
                <input type="file" id="fileInput2" accept="image/*" onchange="previewImage(event, 'preview2')">
                <div class="file-upload-icon">
                    <i class="fas fa-thermometer-three-quarters"></i>
                    <span>MR277 í™”ë©´ ì´¬ì˜/ì—…ë¡œë“œ</span>
                </div>
                <img id="preview2" class="preview-image" onclick="zoomImage(event)">
            </div>
            <p class="zoom-hint">* ê³„ì¸¡ê¸° í™”ë©´ì˜ ìˆ«ìê°€ ì˜ ë³´ì´ê²Œ ì°ì–´ì£¼ì„¸ìš”.</p>
        </div>

        <button class="btn-submit" onclick="generateContent()">
            <i class="fas fa-robot"></i> AI ì •ë°€ ì§„ë‹¨ ì‹œì‘
        </button>

        <div class="loading" id="loadingSpinner">
            <div class="spinner"></div>
            <p>ì²­ê°œêµ¬ë¦¬ AIê°€ ì‚¬ì§„ê³¼ ë°ì´í„°ë¥¼ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...<br>(ì•½ 10~20ì´ˆ ì†Œìš”)</p>
        </div>

        <div id="resultArea"></div>
        
        <div id="zoomModal" class="image-zoom-container">
            <img id="zoomedImg" class="zoomed-image">
            <button class="close-zoom-btn" onclick="closeZoom()">ë‹«ê¸°</button>
        </div>

    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // *** [ë³´ì•ˆ] API í‚¤ ë¶„í•  (GitHub ë´‡ íšŒí”¼ìš©) ***
        const k_part1 = "AIzaSyAZRYWwExOU";
        const k_part2 = "fQSZ_O6uC9pmDzvRsWckIDw";
        const API_KEY = k_part1 + k_part2;
        
        const genAI = new GoogleGenerativeAI(API_KEY);

        // [í•µì‹¬ ê¸°ëŠ¥] MR277 ì—‘ì…€ ë§¤ë‰´ì–¼ì˜ ì§„ë‹¨ ë¡œì§ (í”„ë¡¬í”„íŠ¸ì— ì£¼ì…)
        const mr277ExpertLogic = `
[FLIR MR277 ì •ë°€ ì§„ë‹¨ ê°€ì´ë“œ]
1. ê³„ì¸¡ê¸° í™”ë©´ ë°ì´í„° í•´ì„:
   - AIR: ì£¼ë³€ ê³µê¸° ì˜¨ë„ (Â°C)
   - RH: ìƒëŒ€ ìŠµë„ (%)
   - DEW: ì´ìŠ¬ì  ì˜¨ë„ (Â°C)
   - MIX: í˜¼í•©ë¹„ (g/kg, ê°€ì¥ ì¤‘ìš”í•œ ì§€í‘œ)

2. ì›ì¸ íŒì • ì•Œê³ ë¦¬ì¦˜ (í˜¼í•©ë¹„ ê¸°ì¤€):
   (CASE A) í™˜ê¸° ë¶€ì¡±í˜•:
      - ì¡°ê±´: MIX ê°’ì´ 10.0 g/kg ì´ìƒ ì¸¡ì •ë¨.
      - ì§„ë‹¨: ê³µê¸° ì¤‘ ìˆ˜ë¶„ì´ ê³¼ë‹¤í•¨. ë‹¨ì—´ ë¬¸ì œë³´ë‹¤ í™˜ê¸° ë¬¸ì œê°€ í¼.
   (CASE B) ë‹¨ì—´ ë¶ˆëŸ‰í˜•:
      - ì¡°ê±´: MIX ê°’ì´ 9.0 g/kg ì´í•˜ë¡œ ì •ìƒì´ì§€ë§Œ ê²°ë¡œ ë°œìƒ.
      - ì§„ë‹¨: ê³µê¸°ëŠ” ì •ìƒì´ë‚˜ ë²½ë©´ì´ ë„ˆë¬´ ì°¨ê°€ì›€. ë‹¨ì—´ ì‹œê³µ í•„ìˆ˜.
   (CASE C) ë³µí•©í˜•:
      - ì¡°ê±´: MIXë„ ë†’ê³ , ë²½ë©´ ì˜¨ë„ë„ ì´ìŠ¬ì  ì´í•˜.
`;

        window.generateContent = async function() {
            const fileInput1 = document.getElementById('fileInput1');
            const fileInput2 = document.getElementById('fileInput2');
            const diagnosisDate = document.getElementById('diagnosisDate').value;
            const location = document.getElementById('location').value;
            const tempIn = document.getElementById('tempIn').value;
            const humidIn = document.getElementById('humidIn').value;
            
            const checkboxes = document.querySelectorAll('input[name="area"]:checked');
            let selectedAreas = [];
            checkboxes.forEach((cb) => selectedAreas.push(cb.value));
            const areaString = selectedAreas.join(', ');

            if (!fileInput1.files[0]) {
                alert("ì²« ë²ˆì§¸ ì‚¬ì§„(ê²°ë¡œ/ê³°íŒ¡ì´ ì‚¬ì§„)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }

            // ë¡œë”© ì‹œì‘
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';

            try {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const imageParts = [];
                // íŒŒì¼1 ì²˜ë¦¬
                const file1 = fileInput1.files[0];
                const base64Data1 = await fileToGenerativePart(file1);
                imageParts.push(base64Data1);

                // íŒŒì¼2 ì²˜ë¦¬ (MR277)
                let hasMr277 = false;
                if (fileInput2.files[0]) {
                    const file2 = fileInput2.files[0];
                    const base64Data2 = await fileToGenerativePart(file2);
                    imageParts.push(base64Data2);
                    hasMr277 = true;
                }

                // í”„ë¡¬í”„íŠ¸ ì‘ì„±
                let prompt = `
ë‹¹ì‹ ì€ 'ì²­ê°œêµ¬ë¦¬ ìƒ¤ì‹œìˆ˜ë¦¬'ì˜ ê²°ë¡œ ì§„ë‹¨ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. 
ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ HTML í˜•ì‹ì˜ ì§„ë‹¨ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[ì…ë ¥ ì •ë³´]
- ì¼ì‹œ/ì¥ì†Œ: ${diagnosisDate}, ${location}
- ë¶€ìœ„: ${areaString}
- ê¸°ë³¸ í™˜ê²½: ${tempIn}Â°C, ${humidIn}%
- MR277 ì‚¬ì§„ ì—¬ë¶€: ${hasMr277 ? "ìˆìŒ (ë‘ ë²ˆì§¸ ì‚¬ì§„)" : "ì—†ìŒ"}

[ì§„ë‹¨ ë¡œì§ ê¸°ì¤€]
${mr277ExpertLogic}

[ìš”ì²­ ì‚¬í•­]
1. ì²« ë²ˆì§¸ ì‚¬ì§„(í˜„ì¥)ì„ ë¶„ì„í•˜ì—¬ ê³°íŒ¡ì´/ê²°ë¡œ ìƒíƒœë¥¼ ì„œìˆ í•˜ì„¸ìš”.
2. **ë‘ ë²ˆì§¸ ì‚¬ì§„(MR277)**ì´ ìˆë‹¤ë©´, í™”ë©´ì˜ ìˆ«ì(MIX, DEW ë“±)ë¥¼ ì½ê³  ìœ„ [ì§„ë‹¨ ë¡œì§ ê¸°ì¤€]ì— ë”°ë¼ **í™˜ê¸° ë¶€ì¡± vs ë‹¨ì—´ ë¶ˆëŸ‰**ì„ ëª…í™•íˆ íŒì •í•˜ì„¸ìš”.
3. ê²°ê³¼ëŠ” ê¹”ë”í•œ HTML íƒœê·¸(h3, ul, b ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶œë ¥í•˜ì„¸ìš”. (ë§ˆí¬ë‹¤ìš´ ì‚¬ìš© ê¸ˆì§€)
`;

                const result = await model.generateContent([prompt, ...imageParts]);
                const response = await result.response;
                let text = response.text();

                // ë§ˆí¬ë‹¤ìš´ ì œê±°
                text = text.replace(/```html/g, "").replace(/```/g, "");
                
                document.getElementById('resultArea').innerHTML = text;
                document.getElementById('resultArea').style.display = 'block';

            } catch (error) {
                console.error("Error:", error);
                alert("ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ë° ì¤Œ ê¸°ëŠ¥ (ê¸°ì¡´ ìœ ì§€)
        window.previewImage = function(event, previewId) {
            const input = event.target;
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        window.zoomImage = function(event) {
            if (event.target.style.display === 'none' || !event.target.src) return;
            const modal = document.getElementById('zoomModal');
            const zoomedImg = document.getElementById('zoomedImg');
            zoomedImg.src = event.target.src;
            modal.style.display = 'flex';
        }
        window.closeZoom = function() {
            document.getElementById('zoomModal').style.display = 'none';
        }

        // ì´ˆê¸°ê°’ ì„¸íŒ…
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('diagnosisDate').value = now.toISOString().slice(0,16);

        // ìœ„ì¹˜ ì •ë³´ (ê¸°ì¡´ ìœ ì§€)
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                document.getElementById('weatherDisplay').innerHTML = `
                    <p><i class="fas fa-location-arrow"></i> í˜„ì¥ ì¢Œí‘œ ì¸ì‹ ì™„ë£Œ</p>
                    <p><i class="fas fa-temperature-high"></i> ì‹¤ì™¸ ë‚ ì”¨ ì •ë³´ ìë™ ìˆ˜ì‹  ëŒ€ê¸°ì¤‘...</p>
                `;
            }, function(error) {
                document.getElementById('weatherDisplay').innerHTML = `<p>ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            });
        }
    </script>
</body>
</html>
